#!/usr/local/bin/konoha

include "SEKENS.k";

void main()
{
	SEKENS sekens = new SEKENS();
	String html = sekens.html;
	Cgi cgi = new Cgi();
	if (cgi.cookies["SID"] != null) {
		String sid = cgi.cookies["SID"]["val"];
		Json j = sekens.checkSID(sid);
		if (j != null) {
			String username = j["username"];
			/* [TODO] how to user username? */
			html = html.replace("%script%", "main.js").replace("%username%",
					"<script type=\"text/javascript\">\n<!--\nvar userName = '" + username + "';\n// -->\n</script>");
		}
		else {
			OUT << sekens.deleteCookie("SID");
			html = html.replace("%script%", "top.js").replace("%username%", "");
		}
	}
	else {
		html = html.replace("%script%", "top.js").replace("%username%", "");
	}

	OUT << "Content-Type: text/html\n" << EOL;
	OUT << html;
	OUT.flush();
}
